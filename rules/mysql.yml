# Record slave lag seconds for pre-computed timeseries that takes
# `mysql_slave_status_sql_delay` into account
###
# MySQL Alerts
groups:
- name: MySQLAlerts
  rules:
  - record: mysql_slave_lag_seconds
    expr: mysql_slave_status_seconds_behind_master - mysql_slave_status_sql_delay
  - alert: MySQLReplicationNotRunning
    expr: mysql_slave_status_slave_io_running == 0 or mysql_slave_status_slave_sql_running
      == 0
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "{{ $labels.instance }}: MySQL Slave副本未运行"
      description: "{{ $labels.job }}: MySQL Slave副本 (IO or SQL) 停止运行超过了2分钟."

  - alert: MySQLReplicationLag
    expr: (mysql_slave_lag_seconds > 30) and ON(instance) (predict_linear(mysql_slave_lag_seconds[5m],
      60 * 2) > 0)
    for: 1m
    labels:
      severity: critical
    annotations:
      description: "MySQL Slave副本复制发生滞后，未恢复"
      summary: "MySQL Slave副本复制发生滞后"
  
  - alert: MySQLInnoDBLogWaits
    expr: rate(mysql_global_status_innodb_log_waits[15m]) > 10
    labels:
      severity: warning
    annotations:
      summary: "{{ $labels.instance }}: MySQL innodb 日志写入发生阻塞"
      description: "{{ $labels.job }}: innodb 日志等待写入磁盘的时间为 {{$value}} 秒"

  # Alert for mysql_global_status_connection_errors_total !=0 for >1 minutes.
  - alert: mysql_global_status_connection_errors_total
    expr: mysql_global_status_connection_errors_total !=0
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "{{ $labels.instance }}: mysql_global_status_connection_errors_total的值不为0的时间超过了1分钟"
      description: "{{ $labels.job }}: mysql_global_status_connection_errors_total的值不为0"

  # Alert for mysql_global_status_uptime == 0 for >1 minutes.
  - alert: mysql_global_status_uptime
    expr: mysql_global_status_uptime == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "{{ $labels.instance }}: mysql_global_status_uptime 的值为0的时间超过了1分钟"
      description: "{{ $labels.job }}: mysql_global_status_uptime 的值为0"

  # Alert for mysql_up == 0 for >1 minutes.
  - alert: mysql_up
    expr: mysql_up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "{{ $labels.instance }}: mysql_up的值为0超过了1分钟"
      description: "{{ $labels.job }}: mysql_up的值为0"

  - alert: Mysql_Too_Many_Connections
    expr: rate(mysql_global_status_connections[5m]) > 100
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "{{$labels.instance}}: MySQL连接数增长率过高"
      description: "{{ $labels.job }}: 过去5分钟内MySQL连接增长率>100: {{ $value }}"  

  - alert: Mysql_High_QPS
    expr: rate(mysql_global_status_questions[5m]) > 500 
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "{{$labels.instance}}: 探测到 Mysql_High_QPS"
      description: "{{$labels.instance}} of {{ $labels.job }}: Mysql 操作数超过每秒500 ,(当前值为: {{ $value }})"  

  # Alert for mysql_global_status_threads_cached == 0 for >1 minutes.
  - alert: mysql_global_status_threads_cached 
    expr: mysql_global_status_threads_cached == 0
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "mysql_global_status_threads_cached == 0 for >1 minutes in {{ $labels.instance }}：mysql_global_status_threads_cached 的值为0超过了1分钟"
      description: "{{ $labels.job }}: mysql_global_status_threads_cached 的值为0"

  # Alert for mysql_global_status_threads_connected == 0 for >1 minutes.
  - alert: mysql_global_status_threads_connected
    expr: mysql_global_status_threads_connected == 0
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "{{ $labels.instance }}: mysql_global_status_threads_connected 的值为0超过了1分钟"
      description: "{{ $labels.job }}: mysql_global_status_threads_connected 的值为0"

  # Alert for mysql_global_status_threads_connected > 100 for > 2 minutes.
  - alert: mysql_global_status_threads_connected
    expr: rate(mysql_global_status_threads_connected[5m]) > 100
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "{{$labels.instance}}: 探测到 Mysql 非常多的连接数"
      description: "{{$labels.job}}: Mysql 连接数超过每秒100 ,(当前值为: {{ $value }})"  

  # Alert for mysql_global_status_slow_queries != 0 for >1 minutes.
  - alert: mysql_global_status_slow_queries
    expr: rate(mysql_global_status_slow_queries[5m]) > 0.1
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "{{ $labels.instance }}: mysql_global_status_slow_queries 的值为0的时间超过了1分钟"
      description: "{{ $labels.job }}: mysql_global_status_slow_queries 的值为0"

  # Alert for mysql_global_status_aborted_connects != 0 for >1 minutes.
  - alert: mysql_global_status_aborted_connects
    expr: rate(mysql_global_status_aborted_connects[2m]) > 0.01
    for: 3m
    labels:
      severity: warning
    annotations:
      summary: "{{ $labels.instance }}: mysql_global_status_aborted_connects[2m] > 0.01 的时间超过3分钟"
      description: "{{ $labels.job }}: mysql_global_status_aborted_connects[2m]) > 0.01"
